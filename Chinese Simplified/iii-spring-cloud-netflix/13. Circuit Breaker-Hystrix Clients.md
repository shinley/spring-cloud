## 13. 熔断器: Hystrix客户端

Netflix公司已经创建了一个叫做Hystrix的库，它实现断路器模式. 在微服务体系架构中，有多个层次的服务调用是很常见的.

**图13.1. 微服务图**

![](http://cloud.spring.io/spring-cloud-static/Dalston.SR4/multi/images/HystrixGraph.png "HystrixGraph")

服务级别较低的服务失败可能导致级联故障一直到用户 当对特定服务的调用大于circuitBreaker.requestVolumeThreshold（默认值：20个请求），并且在由metrics.rollingStats.timeInMilliseconds（默认值：10秒）定义的滚动窗口中，故障百分比大于circuitBreaker.errorThresholdPercentage（默认值：> 50％ ），断路器打开，并且不进行请求。 在发生错误并且打开断路器的情况下，开发者可以提供一个回调方法。

**图13.2. Hystrix fallback防止级联故障**

![](http://cloud.spring.io/spring-cloud-static/Dalston.SR4/multi/images/HystrixFallback.png "HystrixFallback")

有一个打开的断电路可以阻止级联故障，并允许过载或失败的服务有时间恢复。 回退(Fallback) 可以是另一个Hystrix保护的调用，静态数据或一个正常的空值。 回退可能会被链接，因此第一个回退会产生一些其他的业务调用，而这些业务调用反过来又会返回到静态数据。

## 13.1 如何添加Hystrix依赖

要在你的项目中加入Hystrix，可以添加group Id 为org.springframework.cloud和artifact Id为spring-cloud-starter-hystrix的起步依赖 请参阅Spring Cloud项目页面，了解如何使用当前的Spring Cloud设置你的系统

启动应用程序的例子:

    @SpringBootApplication
    @EnableCircuitBreaker
    public class Application {
    
        public static void main(String[] args) {
            new SpringApplicationBuilder(Application.class).web(true).run(args);
        }
    
    }
    
    @Component
    public class StoreIntegration {
    
        @HystrixCommand(fallbackMethod = "defaultStores")
        public Object getStores(Map<String, Object> parameters) {
            //do stuff that might fail
        }
    
        public Object defaultStores(Map<String, Object> parameters) {
            return /* something useful */;
        }
    }
    

@hystrixcommand注解由Netflix提供的，在一个名为“javanica”的库中提供。 Spring Cloud自动将Spring bean包装在一个与Hystrix断路器相连的代理中。 断路器计算何时开启和关闭，以及在发生故障时应做什么.

要配置@hystrixcommand，你可以使用commandProperties属性和一个@hystrixproperty注解列表 请参阅此处了解更多细节。 有关可用属性的详细信息，请参阅Hystrix wiki。

## 13.2 传播安全上下文或使用Spring作用域

如果希望某些线程本地上下文传播到@hystrixcommand，那么默认声明将不起作用，因为它在线程池中执行命令(在超时的情况下)。 您可以通过使用不同的“隔离策略”来切换Hystrix和使用某些配置的调用者使用相同的线程，或者直接在注解中使用 例如:

    @HystrixCommand(fallbackMethod = "stubMyService",
        commandProperties = {
          @HystrixProperty(name="execution.isolation.strategy", value="SEMAPHORE")
        }
    )
    ...
    

如果你使用@sessionscope或@requestscope，则同样适用。 您将知道何时需要这样做，因为运行时异常表示它无法找到作用域上下文。

You also have the option to set the`hystrix.shareSecurityContext`property to`true`. Doing so will auto configure an Hystrix concurrency strategy plugin hook who will transfer the`SecurityContext`from your main thread to the one used by the Hystrix command. Hystrix does not allow multiple hystrix concurrency strategy to be registered so an extension mechanism is available by declaring your own`HystrixConcurrencyStrategy`as a Spring bean. Spring Cloud will lookup for your implementation within the Spring context and wrap it inside its own plugin.

## 13.3 Health Indicator

The state of the connected circuit breakers are also exposed in the`/health`endpoint of the calling application

    {
        "hystrix": {
            "openCircuitBreakers": [
                "StoreIntegration::getStoresByLocationLink"
            ],
            "status": "CIRCUIT_OPEN"
        },
        "status": "UP"
    }
    

## 13.4 Hystrix Metrics Stream

To enable the Hystrix metrics stream include a dependency on`spring-boot-starter-actuator`. This will expose the`/hystrix.stream`as a management endpoint.

     <dependency>
         <groupId>org.springframework.boot</groupId>
         <artifactId>spring-boot-starter-actuator</artifactId>
     </dependency>