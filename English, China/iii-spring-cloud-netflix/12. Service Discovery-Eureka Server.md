## 12. 服务发现：Eureka服务端

## 12.1 如何加入Eureka Server服务端的依赖

要在你的项目中加入Eureka Server, 只需要加入 group Id为org.springframework.cloud ，artifact id为spring-cloud-starter-eureka-server的起步依赖即可. 有关使用当前Spring Cloud发布版本设置构建系统的详细信息，请参阅Spring Cloud Project page页面.

## 12.2 如何运行Eureka Server

Eureka客户端的例子;

    @SpringBootApplication
    @EnableEurekaServer
    public class Application {
    
        public static void main(String[] args) {
            new SpringApplicationBuilder(Application.class).web(true).run(args);
        }
    }
    

Eureka服务器具有一个带有UI的主页，以及每一个普通Eureka功能下的提供了HTTP端点，路径为/eureka/*.

Eureka背景: 参考flux capacitor 和 google group discussion.

> 由于Gradle的依赖关系解析规则和父bom功能的缺乏，仅仅依靠spring-cloud-starter-eureka-server可能会导致应用程序启动失败. 要弥补这一点，必须添加Spring Boot Gradle插件，Spring Cloud 起步依赖的父 bom必须像这样导入：:
> 
> **build.gradle.  **
> 
>     buildscript {
>       dependencies {
>         classpath("org.springframework.boot:spring-boot-gradle-plugin:1.3.5.RELEASE")
>       }
>     }
>     
>     apply plugin: "spring-boot"
>     
>     dependencyManagement {
>       imports {
>         mavenBom "org.springframework.cloud:spring-cloud-dependencies:Brixton.RELEASE"
>       }
>     }
>     

## 12.3 高可用， Zones 和 Regions

Eureka服务器没有后端存储，但注册表中的服务实例都必须发送心跳以保持其注册更新（所以这可以在内存中完成）. 客户端也具有eureka注册的内存缓存（因此，他们不必每次请求服务端都到注册中心获取注册表中注册的服务）.

默认情况下，每个Eureka服务器也是Eureka客户端，并且需要（至少一个）服务URL来定位其它兄弟结点Eureka服务器. 如果不提供, 它也能正常的运行和工作， 但是它会产生很多的关于无法注册到其它对等Eureka服务器的噪音日志。.

有关客户端侧的Zones和Regions的支持，也可查查看below for details of Ribbon support.

## 12.4 Standalone Mode

The combination of the two caches (client and server) and the heartbeats make a standalone Eureka server fairly resilient to failure, as long as there is some sort of monitor or elastic runtime keeping it alive (e.g. Cloud Foundry). In standalone mode, you might prefer to switch off the client side behaviour, so it doesn’t keep trying and failing to reach its peers. Example:

**application.yml (Standalone Eureka Server). **

    server:
      port: 8761
    
    eureka:
      instance:
        hostname: localhost
      client:
        registerWithEureka: false
        fetchRegistry: false
        serviceUrl:
          defaultZone: http://${eureka.instance.hostname}:${server.port}/eureka/
    

Notice that the`serviceUrl`is pointing to the same host as the local instance.

## 12.5 Peer Awareness

Eureka can be made even more resilient and available by running multiple instances and asking them to register with each other. In fact, this is the default behaviour, so all you need to do to make it work is add a valid`serviceUrl`to a peer, e.g.

**application.yml (Two Peer Aware Eureka Servers). **

    ---
    spring:
      profiles: peer1
    eureka:
      instance:
        hostname: peer1
      client:
        serviceUrl:
          defaultZone: http://peer2/eureka/
    
    ---
    spring:
      profiles: peer2
    eureka:
      instance:
        hostname: peer2
      client:
        serviceUrl:
          defaultZone: http://peer1/eureka/
    

In this example we have a YAML file that can be used to run the same server on 2 hosts (peer1 and peer2), by running it in different Spring profiles. You could use this configuration to test the peer awareness on a single host (there’s not much value in doing that in production) by manipulating`/etc/hosts`to resolve the host names. In fact, the`eureka.instance.hostname`is not needed if you are running on a machine that knows its own hostname (it is looked up using`java.net.InetAddress`by default).

You can add multiple peers to a system, and as long as they are all connected to each other by at least one edge, they will synchronize the registrations amongst themselves. If the peers are physically separated \(inside a data centre or between multiple data centres) then the system can in principle survive split-brain type failures.

## 12.6 Prefer IP Address

In some cases, it is preferable for Eureka to advertise the IP Adresses of services rather than the hostname. Set`eureka.instance.preferIpAddress`to`true`and when the application registers with eureka, it will use its IP Address rather than its hostname.